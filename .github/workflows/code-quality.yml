name: Code Quality & Security

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  RUBY_VERSION: 3.3.0

jobs:
  # RuboCop - Ruby linter and formatter
  rubocop:
    name: RuboCop
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Install RuboCop
        run: |
          gem install rubocop rubocop-rails rubocop-rspec rubocop-performance

      - name: Run RuboCop
        run: |
          rubocop --parallel --format progress \
            --format json --out rubocop-report.json

      - name: Annotate code with RuboCop results
        uses: reviewdog/action-rubocop@v2
        if: github.event_name == 'pull_request'
        with:
          rubocop_version: latest
          reporter: github-pr-review
          level: warning

      - name: Upload RuboCop report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rubocop-report
          path: rubocop-report.json

  # Brakeman - Security vulnerability scanner
  brakeman:
    name: Brakeman Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}

      - name: Install Brakeman
        run: gem install brakeman

      - name: Run Brakeman
        run: |
          brakeman --format json --output brakeman-report.json \
            --no-pager --no-exit-on-warn --no-exit-on-error
        continue-on-error: true

      - name: Upload Brakeman report
        uses: actions/upload-artifact@v4
        with:
          name: brakeman-report
          path: brakeman-report.json

      - name: Brakeman SARIF report
        run: |
          brakeman --format sarif --output brakeman.sarif --no-pager
        continue-on-error: true

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: brakeman.sarif

  # Bundler Audit - Check for vulnerable dependencies
  bundler-audit:
    name: Bundler Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Install bundler-audit
        run: gem install bundler-audit

      - name: Update vulnerability database
        run: bundle audit update

      - name: Run bundler-audit
        run: bundle audit check

  # Bundle Leak - Check for memory leaks in gems
  bundle-leak:
    name: Bundle Leak Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Install bundler-leak
        run: gem install bundler-leak

      - name: Update leak database
        run: bundle leak update

      - name: Check for leaky gems
        run: bundle leak check

  # Rails Best Practices
  rails-best-practices:
    name: Rails Best Practices
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}

      - name: Install rails_best_practices
        run: gem install rails_best_practices

      - name: Run Rails Best Practices
        run: |
          rails_best_practices . \
            --format json \
            --output-file rails_best_practices.json
        continue-on-error: true

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rails-best-practices
          path: rails_best_practices.json

  # Code complexity analysis
  flog:
    name: Code Complexity (Flog)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}

      - name: Install flog
        run: gem install flog

      - name: Run flog
        run: |
          flog app lib -a > flog-report.txt || true
        continue-on-error: true

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flog-report
          path: flog-report.txt

  # Reek - Code smell detector
  reek:
    name: Code Smells (Reek)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}

      - name: Install reek
        run: gem install reek

      - name: Run reek
        run: |
          reek app lib --format json > reek-report.json || true
        continue-on-error: true

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reek-report
          path: reek-report.json

  # Dependency review (for PRs only)
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          warn-on-openssf-scorecard-level: 3

  # CodeQL Analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ruby
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:ruby"

  # License compliance check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Install license_finder
        run: gem install license_finder

      - name: Check licenses
        run: |
          license_finder report --format json > licenses.json
        continue-on-error: true

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json

  # Summary
  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [rubocop, brakeman, bundler-audit, bundle-leak, rails-best-practices, codeql]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "========================================="
          echo "Code Quality & Security Summary"
          echo "========================================="
          echo "RuboCop: ${{ needs.rubocop.result }}"
          echo "Brakeman: ${{ needs.brakeman.result }}"
          echo "Bundler Audit: ${{ needs.bundler-audit.result }}"
          echo "Bundle Leak: ${{ needs.bundle-leak.result }}"
          echo "Rails Best Practices: ${{ needs.rails-best-practices.result }}"
          echo "CodeQL: ${{ needs.codeql.result }}"
          echo "========================================="

      - name: Create summary
        run: |
          echo "### Code Quality & Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| RuboCop | ${{ needs.rubocop.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Brakeman | ${{ needs.brakeman.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundler Audit | ${{ needs.bundler-audit.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle Leak | ${{ needs.bundle-leak.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rails Best Practices | ${{ needs.rails-best-practices.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | ${{ needs.codeql.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical checks failed
        if: |
          needs.brakeman.result == 'failure' ||
          needs.bundler-audit.result == 'failure' ||
          needs.codeql.result == 'failure'
        run: |
          echo "Critical security checks failed!"
          exit 1

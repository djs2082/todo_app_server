name: Continuous Integration

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]

env:
  RUBY_VERSION: 3.3.0
  RAILS_ENV: test
  DATABASE_HOST: 127.0.0.1
  DATABASE_PORT: 3306
  DATABASE_USERNAME: root
  DATABASE_PASSWORD: password
  DATABASE_NAME: todo_app_test
  REDIS_URL: redis://localhost:6379/0

jobs:
  # Job 1: Lint and Code Quality
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true  # Caches gems automatically

      - name: Install dependencies
        run: |
          gem install bundler
          bundle config set --local path 'vendor/bundle'
          bundle install --jobs 4 --retry 3

      - name: Run RuboCop (Linter)
        run: |
          bundle exec rubocop --parallel --format progress --format json --out rubocop-report.json
        continue-on-error: true

      - name: Upload RuboCop report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rubocop-report
          path: rubocop-report.json
          retention-days: 30

      - name: Check for Rails best practices
        run: |
          gem install rails_best_practices
          rails_best_practices . --format json --output-file rails_best_practices.json
        continue-on-error: true

      - name: Upload Rails Best Practices report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rails-best-practices
          path: rails_best_practices.json
          retention-days: 30

  # Job 2: Security Scanning
  security:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Install dependencies
        run: |
          gem install bundler
          bundle config set --local path 'vendor/bundle'
          bundle install --jobs 4 --retry 3

      - name: Run Brakeman (Security Scanner)
        run: |
          gem install brakeman
          brakeman --format json --output brakeman-report.json --no-pager
        continue-on-error: true

      - name: Upload Brakeman report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brakeman-report
          path: brakeman-report.json
          retention-days: 30

      - name: Run bundler-audit (Dependency Security)
        run: |
          gem install bundler-audit
          bundle audit check --update
        continue-on-error: true

      - name: Run bundle leak check
        run: |
          gem install bundler-leak
          bundle leak check --update
        continue-on-error: true

  # Job 3: Test Suite
  test:
    name: RSpec Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: todo_app_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -ppassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Install dependencies
        run: |
          gem install bundler
          bundle config set --local path 'vendor/bundle'
          bundle install --jobs 4 --retry 3

      - name: Wait for MySQL to be ready
        run: |
          until mysqladmin ping -h 127.0.0.1 -u root -ppassword --silent; do
            echo 'Waiting for MySQL...'
            sleep 2
          done
          echo 'MySQL is ready!'

      - name: Setup database
        env:
          RAILS_ENV: test
        run: |
          bundle exec rails db:create
          bundle exec rails db:schema:load

      - name: Run RSpec tests with coverage
        env:
          RAILS_ENV: test
          COVERAGE: true
        run: |
          bundle exec rspec --format progress --format json --out rspec-report.json

      - name: Upload RSpec report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rspec-report
          path: rspec-report.json
          retention-days: 30

      - name: Check test coverage
        run: |
          if [ -f coverage/.resultset.json ]; then
            echo "Coverage report generated"
            # Parse coverage percentage (requires simplecov)
            bundle exec ruby -e "
              require 'json'
              require 'simplecov'
              SimpleCov.coverage_dir 'coverage'
              result = JSON.parse(File.read('coverage/.resultset.json'))
              covered = result.dig('RSpec', 'coverage').values.flatten.count { |x| x && x > 0 }
              total = result.dig('RSpec', 'coverage').values.flatten.count
              percentage = (covered.to_f / total * 100).round(2)
              puts \"Coverage: #{percentage}%\"
              if percentage < 85
                puts \"ERROR: Coverage #{percentage}% is below minimum 85%\"
                exit 1
              end
            "
          else
            echo "No coverage report found"
          fi

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Publish coverage to Codecov (optional)
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

  # Job 4: Database Migrations Check
  migrations:
    name: Migration Checks
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: todo_app_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -ppassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Install dependencies
        run: |
          gem install bundler
          bundle config set --local path 'vendor/bundle'
          bundle install --jobs 4 --retry 3

      - name: Wait for MySQL
        run: |
          until mysqladmin ping -h 127.0.0.1 -u root -ppassword --silent; do
            sleep 2
          done

      - name: Run migrations
        env:
          RAILS_ENV: test
        run: |
          bundle exec rails db:create
          bundle exec rails db:migrate

      - name: Check for pending migrations
        env:
          RAILS_ENV: test
        run: |
          bundle exec rails db:migrate:status

      - name: Test migration rollback
        env:
          RAILS_ENV: test
        run: |
          # Get the current version
          CURRENT_VERSION=$(bundle exec rails db:version | grep "Current version:" | awk '{print $3}')
          echo "Current version: $CURRENT_VERSION"

          # Rollback one migration
          if [ "$CURRENT_VERSION" != "0" ]; then
            bundle exec rails db:rollback STEP=1

            # Migrate back up
            bundle exec rails db:migrate

            echo "Migration rollback test passed!"
          else
            echo "No migrations to rollback"
          fi

  # Job 5: Build Docker Image (for validation)
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build development image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.new
          target: development
          push: false
          tags: todo-app:dev-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build production image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.new
          target: production
          push: false
          tags: todo-app:prod-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 6: Summary and Notifications
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, security, test, migrations, docker-build]
    if: always()

    steps:
      - name: Check job statuses
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Migrations: ${{ needs.migrations.result }}"
          echo "Docker Build: ${{ needs.docker-build.result }}"

      - name: Post to Slack (optional)
        if: failure()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "CI Failed for ${{ github.repository }} on branch ${{ github.ref_name }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "❌ *CI Failed* for `${{ github.repository }}`\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n<${{ github.event.head_commit.url }}|View Commit>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Fail if any job failed
        if: |
          needs.lint.result == 'failure' ||
          needs.security.result == 'failure' ||
          needs.test.result == 'failure' ||
          needs.migrations.result == 'failure' ||
          needs.docker-build.result == 'failure'
        run: |
          echo "One or more CI jobs failed"
          exit 1

      - name: Success message
        if: success()
        run: |
          echo "✅ All CI checks passed!"
          echo "Ready for deployment"
